{% extends "base.html" %}
{% load static %}

{% block content %}
<section class="statistics container py-4">
  <h1 class="mb-4">Statistics for All Clients</h1>

  <!-- Filter Form -->
  <form method="get" class="mb-4">
    {{ form.as_p }}
    <button type="submit" class="btn btn-primary">Filter</button>
  </form>

  <!-- Display Aggregated Statistics -->
  <ul class="list-unstyled mb-4">
    <li><strong>Total Revenue:</strong> ${{ all_clients_statistics.total_revenue }}</li>
    <li><strong>Total Products Sold:</strong> {{ all_clients_statistics.total_products_sold }}</li>
    <li><strong>Total Orders:</strong> {{ all_clients_statistics.total_orders }}</li>
    <li><strong>Total Clients:</strong> {{ total_clients }}</li>
  </ul>

  <!-- Monthly Order Frequency and Spending Chart -->
  <div class="mb-5">
    <h2 class="mb-3">Monthly Order Frequency &amp; Spending</h2>
    {% if monthly_order_stats %}
      <canvas id="orderFrequencyChart" width="400" height="200"></canvas>
    {% else %}
      <p>No order frequency data available for the selected date range.</p>
    {% endif %}
  </div>

  <!-- Monthly Average Order Value Chart -->
  <div class="mb-5">
    <h2 class="mb-3">Monthly Average Order Value (AOV)</h2>
    {% if monthly_aov %}
      <canvas id="averageOrderValueChart" width="400" height="200"></canvas>
    {% else %}
      <p>No Average Order Value data available for the selected date range.</p>
    {% endif %}
  </div>

  <!-- Lifetime Value Chart -->
  <div class="mb-5">
    <h2 class="mb-3">Lifetime Value (LTV) with Baseline</h2>
    {% if ltv_data %}
      <canvas id="lifetimeValueChart" width="400" height="200"></canvas>
    {% else %}
      <p>No Lifetime Value data available for the selected grouping.</p>
    {% endif %}
  </div>
</section>

<!-- Load Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/client_statistics.js' %}"></script>
<script src="{% static 'js/average_order_value.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
<script src="{% static 'js/ltv_chart.js' %}"></script>

<!-- Embed Data using separate <script> tags -->
{% if monthly_order_stats %}
  <script id="monthlyOrderStatsData" type="application/json">
    {{ monthly_order_stats|safe }}
  </script>
{% endif %}

{% if monthly_aov %}
  <script id="averageOrderValueData" type="application/json">
    {{ monthly_aov|safe }}
  </script>
{% endif %}

{% if ltv_data %}
  <script id="ltvData" type="application/json">
    {{ ltv_data|safe }}
  </script>
  <script id="baselineValue" type="application/json">
    {{ baseline_value|safe }}
  </script>
{% endif %}
{% endblock %}
